# SmartFollow CRM v1.7.0 - Multi-Tenant & Trial System ğŸ‰

**Release Date:** November 9, 2025

---

## ğŸŒŸ Highlights

SmartFollow v1.7.0 introduces **enterprise-grade multi-tenancy** and a complete **trial & billing system**, enabling true SaaS capabilities with account-based data isolation and plan management.

---

## ğŸ¢ Multi-Tenant System

### What's New

**Complete data isolation between accounts:**
- Each company/organization gets its own isolated workspace
- Users can only see data from their own account
- System admins can manage multiple accounts

**Technical Implementation:**
- Account-based filtering across all entities (Companies, Contacts, Deals, Tasks)
- Secure data isolation at database query level
- Account context switching for system administrators
- All API endpoints automatically filter by `account_id`

**What This Means:**
- ğŸ”’ Your data is completely private and isolated
- ğŸ¢ Perfect for agencies managing multiple clients
- ğŸ‘¥ Each client account has its own users and data
- ğŸ” No data leakage between accounts

---

## ğŸ“Š Trial & Billing System

### Plan Tiers

#### ğŸ **TRIAL** (14 days free)
- **Full ENTERPRISE access** for 14 days
- Unlimited users, companies, and deals
- All features unlocked
- No credit card required

#### ğŸš€ **STARTER** - â‚¬9/user/month
- Perfect for small teams
- **Limits:** 3 users, 100 companies, 500 deals
- **Features:** Dashboard, Companies, Contacts, Deals, Tasks, Search
- CSV export, email logs

#### ğŸ’¼ **PRO** - â‚¬29/user/month
- For growing teams
- **Limits:** 10 users, 1,000 companies, 5,000 deals
- **Features:** Everything in Starter, plus:
  - Admin Users module
  - Advanced reports
  - Multi-company management
  - API access (basic)

#### ğŸ† **ENTERPRISE** - â‚¬79/user/month
- For large organizations
- **Limits:** Unlimited everything
- **Features:** Everything in Pro, plus:
  - Full API access
  - Advanced analytics
  - White-label ready
  - Priority support

### Trial Logic

```
Day 0-14:   ğŸ‰ Full ENTERPRISE access
Day 15-21:  âš ï¸  Grace period - choose a plan
Day 22+:    ğŸ”’ Account locked - must upgrade
```

### New Billing Features

- **Trial countdown** - See exactly how many days remain
- **Grace period warnings** - 7 days to choose a plan after trial
- **Auto-lock mechanism** - Accounts automatically lock after grace period
- **Visual plan selection** - Beautiful UI in Settings â†’ Billing
- **Plan status display** - Always know your current plan and limits

---

## ğŸ†• What's New

### Backend API

#### New Endpoints
- `GET /api/billing/current` - Current plan and subscription status
- `GET /api/billing/plans` - List all available plans
- `POST /api/billing/upgrade` - Upgrade/change plan
- `GET /api/billing/status` - Detailed account status

#### New Middlewares
- `attachAccount()` - Loads account context
- `requireMinPlan('PRO')` - Require minimum plan level
- `requireFeature('adminUsers')` - Check feature availability
- `checkLimit('companies')` - Enforce entity limits
- `requireActiveAccount()` - Block locked/grace accounts

#### Plan Configuration
- Centralized plan config in `src/config/plans.ts`
- Feature flags per plan (dashboard, adminUsers, reports, apiAccess)
- Limit definitions (maxUsers, maxCompanies, maxDeals)
- Easy to extend with new plans or features

### Frontend (Desktop App)

#### New Views
- **Settings menu** (âš™ï¸ icon in sidebar)
- **Billing page** - Plan selection and management

#### UI Improvements
- Trial status banner with countdown
- Grace period warnings (red alert)
- Plan comparison cards
- Upgrade buttons with visual feedback
- Color-coded plan badges (Trial=gray, Starter=blue, Pro=purple, Enterprise=yellow)

### Scripts & Automation

#### Setup Scripts
```bash
npm run setup:multi-tenant    # Initialize multi-tenant database
npm run migrate:trial-system  # Add trial system fields
npm run billing:maintenance   # Lock expired trials (cron job)
```

#### Cron Job (Optional)
```bash
# Auto-lock expired trials daily at 2 AM
pm2 start dist/scripts/billing-maintenance.js \
  --cron "0 2 * * *" \
  --name "billing-cron"
```

---

## ğŸ”§ Technical Details

### Database Schema Changes

**New Table:**
- `accounts` - Organization/company accounts

**New Columns:**
- `users.account_id` â†’ References `accounts.id`
- `companies.account_id` â†’ References `accounts.id`
- `contacts.account_id` â†’ References `accounts.id`
- `deals.account_id` â†’ References `accounts.id`
- `tasks.account_id` â†’ References `accounts.id`
- `accounts.plan_locked` â†’ Boolean, default false
- `accounts.trial_ends_at` â†’ Timestamp, nullable
- `accounts.grace_ends_at` â†’ Timestamp, nullable

**Type Changes:**
- `accounts.billing_plan`: `'FREE'` â†’ `'TRIAL'` (default)
- `users.plan`: Added support for `'TRIAL'`

### API Breaking Changes

âš ï¸ **BREAKING CHANGES:**

1. **Login response now includes:**
   ```json
   {
     "user": {
       "plan": "TRIAL",
       "account_id": 1
     }
   }
   ```

2. **All entity endpoints now filter by account:**
   - `GET /api/companies` - Only returns companies for user's account
   - `GET /api/contacts` - Only returns contacts for user's account
   - `GET /api/deals` - Only returns deals for user's account
   - `GET /api/tasks` - Only returns tasks for user's account

3. **Service method signatures updated:**
   ```typescript
   // Old
   getAllCompanies()
   
   // New
   getAllCompanies(accountId?: number)
   ```

### Security Improvements

- âœ… Complete data isolation between accounts
- âœ… Plan-based access control
- âœ… Feature enforcement at middleware level
- âœ… Limit checks before entity creation
- âœ… Account status validation (TRIAL/GRACE/LOCKED)

---

## ğŸ“¦ Installation & Upgrade

### New Installations

```bash
# Clone repository
git clone https://github.com/ivartammela-stack/Smart.git
cd Smart

# Install dependencies
cd apps/server && npm ci
cd ../desktop && npm ci

# Setup database
cd apps/server
npm run migrate:trial-system
npm run setup:multi-tenant

# Start server
npm run build
npm start

# Run desktop app
cd ../desktop
npm run electron:dev
```

### Upgrading from v1.6.x

**âš ï¸ Important: Backup your database before upgrading!**

```bash
# 1. Backup
sudo -u postgres pg_dump smartfollow_db > backup_$(date +%F).sql

# 2. Pull code
git fetch origin
git checkout main
git pull origin main

# 3. Install dependencies
cd apps/server
npm ci

# 4. Run migrations (CRITICAL ORDER!)
npm run migrate:trial-system    # Adds trial fields to accounts
npm run setup:multi-tenant      # Creates default account, assigns existing data

# 5. Build and restart
npm run build
pm2 restart smartfollow-server

# 6. Verify
curl http://localhost:3000/health
curl http://localhost:3000/api/billing/plans
```

**What happens to existing data:**
- All existing users â†’ assigned to `account_id = 1` (Default Account)
- All existing companies/contacts/deals/tasks â†’ assigned to `account_id = 1`
- Default account set to **TRIAL** plan with 14 days trial + 7 days grace
- Admin user role upgraded to `system_admin`

---

## ğŸ§ª Testing

### Server Testing

```bash
# Login
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@smartfollow.ee","password":"Passw0rd"}'

# Get current plan (use token from login)
curl http://localhost:3000/api/billing/current \
  -H "Authorization: Bearer YOUR_TOKEN"

# Get available plans
curl http://localhost:3000/api/billing/plans \
  -H "Authorization: Bearer YOUR_TOKEN"

# Upgrade plan
curl -X POST http://localhost:3000/api/billing/upgrade \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"planId":"PRO"}'
```

### Desktop Testing

1. **Login** - Verify trial badge appears in sidebar
2. **Settings** - Click âš™ï¸ icon, verify Billing page opens
3. **Trial Status** - Check trial countdown shows "14 days remaining"
4. **Multi-tenant** - Create company, verify it's assigned to correct account
5. **Plan Upgrade** - Test upgrading to STARTER/PRO/ENTERPRISE

---

## ğŸ”® What's Next (v1.8.0)

- ğŸ“§ Email notifications for trial expiration
- ğŸ”Œ External integrations (Google Calendar, Outlook, Zapier)
- ğŸ“Š Advanced analytics & forecasting
- ğŸ¨ White-label customization (ENTERPRISE)
- ğŸ”‘ API token management system
- ğŸ¤– Workflow automation & webhooks
- ğŸ“ Audit logs
- ğŸŒ Multi-language support

---

## ğŸ‘¥ Contributors

- SmartFollow Development Team

---

## ğŸ“ Full Commit History

```
56696e0 fix: Add @ts-nocheck to setup-multi-tenant script
d10c21c fix: Use sequelize.literal for NULL checks in setup script
b8f87d1 fix: TypeScript errors in multi-tenant + trial system
0ce1085 feat: Complete Trial System - FREEâ†’TRIAL + Billing Maintenance
c807f7f feat: Trial Plan System (Frontend) - Settings & Billing UI
5b90225 feat: Trial Plan System (Backend) - TRIAL/STARTER/PRO/ENTERPRISE
4cdc5a6 feat: add multi-tenant setup script and update seed data (Part 6)
c9fde44 feat: add multi-tenant filtering to Search and Reports (Part 5)
652e6be feat: add multi-tenant filtering to Task service (Part 4)
764f266 feat: add multi-tenant filtering to Deal service (Part 3)
17f017f feat: add multi-tenant filtering to Contact service (Part 2)
8c9aa88 feat: implement multi-tenant system - Account model (Part 1)
```

---

## ğŸ“„ License

Copyright Â© 2025 SmartFollow. All rights reserved.

---

## ğŸ†˜ Support

For issues or questions:
- GitHub Issues: https://github.com/ivartammela-stack/Smart/issues
- Email: support@smartfollow.ee

---

**Enjoy SmartFollow v1.7.0!** ğŸŠ


name: CI - Lint & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:

jobs:
  # Backend lint & test
  backend-lint-test:
    name: Backend - Lint & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      
      - name: Setup Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8  # v4.0.2
        with:
          node-version: 20
      
      - name: Install deps
        working-directory: apps/server
        run: npm ci
      
      - name: Lint
        working-directory: apps/server
        run: npm run lint
      
      - name: Type check
        working-directory: apps/server
        run: npx tsc --noEmit
      
      - name: Tests
        working-directory: apps/server
        run: npm test

  # Desktop lint & test
  desktop-lint-test:
    name: Desktop - Lint & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      
      - name: Setup Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8  # v4.0.2
        with:
          node-version: 20
      
      - name: Install deps
        working-directory: apps/desktop
        run: npm ci
      
      - name: Lint
        working-directory: apps/desktop
        run: npm run lint
      
      - name: Type check
        working-directory: apps/desktop
        run: npx tsc --noEmit
      
      - name: Tests
        working-directory: apps/desktop
        run: npm test

  # Summary job
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [backend-lint-test, desktop-lint-test]
    if: always()
    
    steps:
      - name: Check status
        run: |
          if [ "${{ needs.backend-lint-test.result }}" == "success" ] && [ "${{ needs.desktop-lint-test.result }}" == "success" ]; then
            echo "✅ All checks passed!"
            exit 0
          else
            echo "❌ Some checks failed:"
            echo "Backend: ${{ needs.backend-lint-test.result }}"
            echo "Desktop: ${{ needs.desktop-lint-test.result }}"
            exit 1
          fi


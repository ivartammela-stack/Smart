name: Release - Build Installer

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write  # Required for creating releases and uploading assets

jobs:
  release:
    name: Build & Release Installer
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
      
      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8  # v4.0.2
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/desktop/package-lock.json
      
      - name: Install backend dependencies
        working-directory: apps/server
        run: npm ci
      
      - name: Build backend
        working-directory: apps/server
        run: npm run build
      
      - name: Install desktop dependencies
        working-directory: apps/desktop
        run: npm ci
      
      - name: Build desktop app
        working-directory: apps/desktop
        run: npm run build
      
      - name: Build Electron installer
        working-directory: apps/desktop
        run: npm run dist:win
        env:
          # Skip electron-builder auto-publish (we use softprops/action-gh-release instead)
          EP_DRAFT: true
          EP_PRE_RELEASE: false
      
      - name: Get version from tag
        id: get_version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@9d7c94cfd0a1f3ed45544c887983e9fa900f0564  # v2.0.4
        with:
          files: |
            apps/desktop/release/SmartFollow-Setup-*.exe
            apps/desktop/release/*.exe.blockmap
          draft: false
          prerelease: false
          generate_release_notes: true
          name: SmartFollow CRM v${{ steps.get_version.outputs.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

